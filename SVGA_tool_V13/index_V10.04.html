<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SVGA Asset Replacement Tool | V10 (Tech UI Edition)</title>
    
    <style>
        /* --- V13: Dark Mode / Tech Style (Kept as requested) --- */
        body {
            font-family: 'Inter', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif; 
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background-color: #0d0d0d; 
            color: #e0e0e0; 
            line-height: 1.6;
            overflow-x: hidden; 
            position: relative;
        }

        /* Background Grid Pattern */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%231a1a1a' fill-opacity='0.6' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
            background-repeat: repeat;
            opacity: 0.8; 
            pointer-events: none; 
            z-index: -1; 
        }

        /* --- Main Content Area (Dark Card) --- */
        .main-area {
            max-width: 960px; 
            width: 95%;
            margin: 40px auto;
            background-color: #1a1a1a; 
            border-radius: 12px; 
            box-shadow: 0 10px 40px rgba(0, 255, 128, 0.05); 
            border: 1px solid rgba(30, 255, 128, 0.1); 
            padding: 35px;
            animation: fadeIn 0.8s ease-out;
            position: relative; 
            z-index: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Status Bar Styles --- */
        .status-bar {
            margin-bottom: 25px;
            padding: 15px 20px;
            border-radius: 8px; 
            font-weight: 600;
            display: none;
            font-size: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 1px solid; 
        }
        .status-error { background-color: #3d1b1b; border-color: #7b2929; color: #ff8c8c; } 
        .status-success { background-color: #1b3d2b; border-color: #297b4a; color: #8cffad; } 
        .status-loading { background-color: #1b2e3d; border-color: #29577b; color: #8cb2ff; } 
        
        /* --- Title Styles --- */
        h1 {
            text-align: center;
            color: #00ff80; 
            font-size: 2.5em; 
            margin-bottom: 30px;
            font-weight: 800; 
            letter-spacing: 1px; 
            text-shadow: 0 0 15px rgba(0, 255, 128, 0.4); 
        }
        h3 {
            color: #00ff80; 
            font-size: 1.4em;
            margin-top: 35px;
            margin-bottom: 18px;
            border-bottom: 1px solid rgba(0, 255, 128, 0.2); 
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* --- Button Group --- */
        .btn-group {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }
        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 8px; 
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            background-color: #2a2a2a; 
            border: 1px solid #4a4a4a; 
            color: #e0e0e0;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            background-color: #3a3a3a;
        }
        .btn-primary { 
            background: linear-gradient(45deg, #00ff80, #00e676); 
            color: #1a1a1a; 
            border: none;
            box-shadow: 0 4px 20px rgba(0, 255, 128, 0.4); 
            font-weight: 700;
        }
        .btn-primary:hover { 
            background: linear-gradient(45deg, #00e676, #00ff80); 
            box-shadow: 0 6px 25px rgba(0, 255, 128, 0.6);
        }
        .btn-download { 
            background: linear-gradient(45deg, #00e676, #00b368); 
            color: #1a1a1a;
            border: none;
            box-shadow: 0 4px 20px rgba(0, 255, 128, 0.4);
            font-weight: 700;
        }
        .btn-download:hover { 
            background: linear-gradient(45deg, #00b368, #00e676);
            box-shadow: 0 6px 25px rgba(0, 255, 128, 0.6);
        }
        input[type=file] { display: none; }

        /* --- Player Area --- */
        #player-wrapper { 
            position: relative;
            height: auto; 
            min-height: 250px;
            width: 100%;
            background-color: #2a2a2a; 
            border: 1px solid #4a4a4a;
            border-radius: 10px; 
            margin-bottom: 25px; /* 增加底部间距以容纳状态栏 */
            overflow: hidden; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.4); 
        }
        
        #drag-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(26, 26, 26, 0.9); 
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            z-index: 20; 
            pointer-events: none;
            color: #b0b0b0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        #drag-overlay.hidden { display: none; }
        #drag-overlay.drag-over { 
            background-color: rgba(0, 255, 128, 0.15); 
            border: 4px dashed #00ff80; 
            color: #00ff80;
        }
        #drag-overlay svg { margin-bottom: 15px; color: #00ff80; width: 60px; height: 60px; } 
        #drag-overlay span { font-size: 18px; font-weight: 500; margin-bottom: 5px; color: #e0e0e0; }
        #drag-overlay div { font-size: 14px; color: #a0a0a0; }

        #playerCanvas { 
            width: 0px; 
            height: 0px; 
            position: relative;
            transition: background-color 0.3s ease;
            border-radius: 8px; 
            overflow: hidden;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        #playerCanvas canvas {
            width: 100% !important;
            height: 100% !important;
            display: block; 
        }
        
        #playerStatus {
            position: absolute;
            top: 15px; left: 15px; font-size: 13px; color: #00ff80; 
            z-index: 10;
            background-color: rgba(26, 26, 26, 0.7); 
            padding: 5px 10px;
            border-radius: 6px;
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
            border: 1px solid rgba(0, 255, 128, 0.2);
        }
        #fileDimensions { font-size: 14px; font-weight: normal; color: #a0a0a0; margin-left: 8px; }

        /* --- Color Selector --- */
        #color-selector {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
            padding: 10px 0;
            border-top: 1px solid rgba(0, 255, 128, 0.1); 
            border-bottom: 1px solid rgba(0, 255, 128, 0.1);
        }
        .color-swatch {
            width: 35px; height: 35px; border-radius: 50%;
            cursor: pointer; 
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            display: inline-block;
            border: 2px solid transparent;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .color-swatch:hover { 
            transform: scale(1.15); 
            box-shadow: 0 4px 12px rgba(0, 255, 128, 0.4); 
            border-color: #00ff80; 
        }
        .color-swatch[data-color="#FFFFFF"] { border: 2px solid #666; } 

        /* --- Assets List --- */
        .assets-list { 
            background-color: #222222; 
            border: 1px solid #4a4a4a; 
            border-radius: 10px; 
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .asset-item { 
            display: flex; 
            align-items: center; 
            padding: 15px 20px; 
            border-bottom: 1px solid #333333; 
            background-color: #222222; 
            transition: background-color 0.2s ease;
        }
        .asset-item:last-child { border-bottom: none; }
        .asset-item:hover { background-color: #2a2a2a; }

        .asset-preview { 
            width: 60px; height: 60px;
            object-fit: contain; 
            background-color: #3a3a3a; 
            border-radius: 6px; 
            margin-right: 20px; 
            border: 1px solid #5a5a5a; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .asset-info { flex: 1; }
        .asset-key { font-weight: 700; font-size: 16px; margin-bottom: 5px; color: #e0e0e0; }
        .asset-meta { font-size: 13px; color: #a0a0a0; }
        
        .download-icon { 
            margin-right: 15px; 
            color: #a0a0a0; 
            transition: color 0.2s ease, transform 0.2s ease; 
            padding: 8px;
            border-radius: 50%;
        }
        .download-icon:hover { color: #00ff80; transform: scale(1.1); background-color: #3a3a3a; }
        .download-icon svg { width: 20px; height: 20px; display: block; }

        .btn-upload-small { 
            padding: 8px 15px; 
            background: linear-gradient(45deg, #00b368, #00804d); 
            color: #e0e0e0; 
            font-size: 13px; 
            border-radius: 6px; 
            cursor: pointer; 
            box-shadow: 0 2px 10px rgba(0, 255, 128, 0.2);
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .btn-upload-small:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(0, 255, 128, 0.3);
            background: linear-gradient(45deg, #00804d, #00b368);
        }
        
        .placeholder {
            padding: 30px; 
            text-align: center; 
            color: #888; 
            font-size: 1.1em;
            background-color: #2a2a2a;
            border: 1px dashed #4a4a4a;
        }

    </style>
</head>
<body>

<div class="main-area">
    
    <h1>SVGA Animation Asset Replacement Tool</h1>
    
    <div class="btn-group">
        <label class="btn btn-primary">
            <svg fill="currentColor" width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 8px;"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6zM13 5.09L18.91 11H13V5.09z"/></svg>
            Load SVGA File
            <input type="file" id="svgaInput" accept=".svga">
        </label>
        <button id="downloadBtn" class="btn btn-download" disabled>
            <svg fill="currentColor" width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 8px;"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            Export New File
        </button>
    </div>

    <h3>Animation Preview <span id="fileDimensions"></span></h3>
    <div id="player-wrapper">
        <div id="drag-overlay">
            <svg fill="currentColor" width="60" height="60" viewBox="0 0 24 24" style="margin-bottom: 15px;"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11zM10.71 14.29l1.59 1.59V12h1.4v3.88l1.59-1.59.99.99-3 3-3-3 .99-.99z"/></svg>
            <span>Drag & Drop your SVGA file here to preview</span>
            <div>(Supports .svga files. Animation dimensions will match automatically.)</div>
            <div style="font-size:12px; margin-top:10px; color:#aaa;">Trouble? Open Console (F12) for detailed logs.</div>
        </div>

        <div id="playerCanvas">
             </div>
        <span id="playerStatus" style="color:#ccc">Waiting for file load...</span>
    </div>

    <div id="statusBar" class="status-bar"></div>
    
    <h3>Background Color Selection</h3>
    <div id="color-selector">
        <span class="color-swatch" data-color="#000000" style="background:#000000" title="Black"></span>
        <span class="color-swatch" data-color="#FFFFFF" style="background:#FFFFFF" title="White"></span>
        <span class="color-swatch" data-color="#3D82FF" style="background:#3D82FF" title="Blue"></span>
        <span class="color-swatch" data-color="#55C464" style="background:#55C464" title="Green"></span>
        <span class="color-swatch" data-color="#FFDD33" style="background:#FFDD33" title="Yellow"></span>
        <span class="color-swatch" data-color="#FF4040" style="background:#FF4040" title="Red"></span>
        <span class="color-swatch" data-color="#F2F2F2" style="background:#F2F2F2" title="Light Gray"></span>
        <span class="color-swatch" data-color="#E0E0E0" style="background:#E0E0E0" title="Medium Gray"></span>
    </div>

    <h3>Asset List (Click to Replace, Right-Click to Download)</h3>
    <div class="assets-list" id="assetsList">
        <div class="placeholder">Upload an SVGA file to display the asset list here.</div>
    </div>
</div>

<script>
    
    // ===================================================================
    // !!! CRITICAL STEP: PASTE DEPENDENCIES HERE !!!
    // Paste the *COMBINED* content of protobuf.min.js, pako.min.js, 
    // and svga.min.js immediately below this line.
    // ===================================================================
    // ===================================================================

    // --- SVGA Tool Core Logic (Embedded, functionally V10/V13 compatible) ---

    // --- Protobuf Definition (Keep unchanged) ---
    const officialProtoDefinition = `
    syntax = "proto3";
    package com.opensource.svga;
    message MovieParams { float viewBoxWidth = 1; float viewBoxHeight = 2; int32 fps = 3; int32 frames = 4; }
    message Rect { float x = 1; float y = 2; float width = 3; float height = 4; }
    message Transform { float a = 1; float b = 2; float c = 3; float d = 4; float tx = 5; float ty = 6; }
    message Point { float x = 1; float y = 2; }
    message Layout { float x = 1; float y = 2; float width = 3; float height = 4; }
    message ShapeEntity { enum ShapeType { SHAPE = 0; RECT = 1; ROUNDED_RECT = 2; ELLIPSE = 3; POLYGON = 4; TEXT = 5; } ShapeType type = 1; string args = 2; ShapeStyle styles = 3; Transform transform = 4; }
    message ShapeStyle { float fillR = 1; float fillG = 2; float fillB = 3; float fillA = 4; float strokeR = 5; float strokeG = 6; float strokeB = 7; float strokeA = 8; float strokeWidth = 9; float miterLimit = 10; repeated float lineDash = 11; int32 lineCap = 12; int32 lineJoin = 13; }
    message FrameEntity { float alpha = 1; Layout layout = 2; Transform transform = 3; string clipPath = 4; repeated ShapeEntity shapes = 5; repeated string events = 6; repeated string filters = 7; }
    message SpriteEntity { string imageKey = 1; repeated FrameEntity frames = 2; string zPosition = 3; repeated string events = 4; }
    message AudioEntity { string audioKey = 1; int32 startFrame = 2; int32 endFrame = 3; int32 startTime = 4; int32 totalTime = 5; }
    message MovieEntity { string version = 1; MovieParams params = 2; map<string, bytes> images = 3; repeated SpriteEntity sprites = 4; repeated AudioEntity audios = 5; }
    `;

    let MovieEntity = null;
    let currentMovieData = null; 
    let player = null; 
    let parser = null;
    const objectUrls = {};
    let currentBgColor = "#FFFFFF"; 

    // --- English Status Messages (Kept as V13) ---
    const StatusMessages = {
        'initial_success': 'Core components loaded successfully. Waiting for file import.',
        'load_start': (fileName) => `⏳ Loading and parsing file: ${fileName}...`,
        'file_format_error': '❌ File format error. Please drop a .svga file.',
        'init_fail': (msg) => `❌ Initialization failed (Protobuf/SVGA): ${msg}`,
        'missing_files': (missing) => `❌ Launch failed: Missing core components: ${missing.join(', ')}. Please check the embedded script.`,
        'parse_success': (count) => `✅ File parsed successfully! Contains ${count} image(s).`,
        'decode_fail': (msg) => `❌ Core decoding failed. Is it a standard SVGA? Details: ${msg}`,
        'player_init_fail': (msg) => `❌ SVGA Player re-initialization failed: ${msg}`,
        'preview_loading': 'Loading preview...',
        'preview_success': 'Dynamic preview successful',
        'preview_fail_player': 'Dynamic preview failed (SVGA Player load error)',
        'preview_fail_gen': 'Preview generation error',
        'export_success': '✅ File exported successfully!',
        'export_fail': (msg) => `❌ File export failed: ${msg}`,
        'replace_success': (key) => `✅ Asset "${key}" replaced! Updating dynamic preview...`,
        'bg_color_set': (color) => `✅ Background color set to ${color}.`,
        'file_load_fail_status': 'File load failed',
        'parse_fail_placeholder': 'File parsing failed. Check console for error details.',
        'no_assets_placeholder': 'This SVGA file contains no image assets.',
    };

    function setStatus(type, msg) {
        console.log(`[Status] ${type}: ${msg}`);
        const el = document.getElementById('statusBar');
        el.style.display = 'block';
        el.className = `status-bar status-${type}`;
        
        if (typeof msg === 'function') {
            el.innerHTML = msg();
        } else {
            el.innerHTML = msg;
        }
    }

    // --- Core Initialization Logic ---
    window.onload = () => {
        console.log("Initialization started...");
        
        // V13 Check: Verify if embedded dependencies are loaded
        if (typeof protobuf === 'undefined' || typeof pako === 'undefined' || typeof SVGA === 'undefined') {
            const missing = [];
            if (typeof protobuf === 'undefined') missing.push('protobuf');
            if (typeof pako === 'undefined') missing.push('pako');
            if (typeof SVGA === 'undefined') missing.push('SVGA');
            
            setStatus('error', StatusMessages.missing_files(missing));
            return;
        }
        
        try {
            const parsed = protobuf.parse(officialProtoDefinition, { keepCase: true });
            MovieEntity = parsed.root.lookupType("com.opensource.svga.MovieEntity");
            parser = new SVGA.Parser();
            console.log("SVGA.Parser initialized successfully.");

            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.addEventListener('click', (e) => {
                    const color = e.target.getAttribute('data-color');
                    currentBgColor = color; 
                    document.getElementById('playerCanvas').style.backgroundColor = color; 
                    setStatus('success', StatusMessages.bg_color_set(color));
                });
            });

            document.getElementById('playerCanvas').style.backgroundColor = currentBgColor;

            const dropArea = document.getElementById('player-wrapper');
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                document.getElementById('drag-overlay').classList.add('drag-over');
            });
            dropArea.addEventListener('dragleave', (e) => {
                document.getElementById('drag-overlay').classList.remove('drag-over');
            });
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                document.getElementById('drag-overlay').classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file) {
                    const extension = file.name.split('.').pop().toLowerCase();
                    if (extension === 'svga') { 
                        loadFile(file);
                    } else {
                        setStatus('error', StatusMessages.file_format_error);
                    }
                }
            });

            document.getElementById('svgaInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const extension = file.name.split('.').pop().toLowerCase();
                    if (extension === 'svga') {
                        loadFile(file);
                    } else {
                        setStatus('error', StatusMessages.file_format_error);
                    }
                }
            });

            setStatus('success', StatusMessages.initial_success);
        } catch (e) {
            setStatus('error', StatusMessages.init_fail(e.message));
            console.error("Initialization error:", e);
        }
    };
    
    // --- File Loading and Parsing Logic ---
    async function loadFile(file) {
        setStatus('loading', StatusMessages.load_start(file.name));
        document.getElementById('downloadBtn').disabled = true;
        document.getElementById('assetsList').innerHTML = `<div class="placeholder">Parsing SVGA file, please wait...</div>`;
        document.getElementById('playerStatus').textContent = 'Loading...';
        document.getElementById('fileDimensions').textContent = 'Calculating...';
        
        document.getElementById('drag-overlay').classList.add('hidden');
        
        document.getElementById('playerCanvas').innerHTML = ''; 
        document.getElementById('playerCanvas').style.width = '0px'; 
        document.getElementById('playerCanvas').style.height = '0px'; 
        
        if (player) {
            player.stopAnimation();
            player.clear();
        }

        try {
            player = new SVGA.Player('#playerCanvas', { renderer: 'canvas' }); 
            player.setContentMode("Fill"); 
            player.loops = 0; 
            console.log("SVGA.Player instance recreated.");
        } catch(e) {
            setStatus('error', StatusMessages.player_init_fail(e.message));
            console.error("SVGA Player re-initialization error:", e);
            document.getElementById('drag-overlay').classList.remove('hidden'); 
            return;
        }

        try {
            const buffer = await file.arrayBuffer();
            let inflatedData;
            
            try {
                inflatedData = pako.inflate(new Uint8Array(buffer));
            } catch (err) {
                inflatedData = new Uint8Array(buffer);
            }

            currentMovieData = MovieEntity.decode(inflatedData);
            
            setStatus('success', StatusMessages.parse_success(Object.keys(currentMovieData.images || {}).length));

            renderAssetsList(currentMovieData.images);
            tryDynamicPreview(); 

            document.getElementById('downloadBtn').disabled = false;

        } catch (err) {
            setStatus('error', StatusMessages.decode_fail(err.message));
            console.error("Protobuf decoding or file read error:", err);
            document.getElementById('playerStatus').textContent = StatusMessages.file_load_fail_status;
            document.getElementById('assetsList').innerHTML = `<div class="placeholder" style="color:#ff8c8c;">${StatusMessages.parse_fail_placeholder}</div>`;
            document.getElementById('drag-overlay').classList.remove('hidden'); 
        }
    }

    // --- Dynamic Preview ---
    function tryDynamicPreview() {
        if (!currentMovieData || !player) return; 
        
        player.stopAnimation();
        player.clear(); 
        
        const { viewBoxWidth, viewBoxHeight } = currentMovieData.params;
        
        const playerCanvas = document.getElementById('playerCanvas');
        playerCanvas.style.width = `${viewBoxWidth}px`;
        playerCanvas.style.height = `${viewBoxHeight}px`;
        playerCanvas.style.backgroundColor = currentBgColor;

        document.getElementById('fileDimensions').textContent = `(${viewBoxWidth} x ${viewBoxHeight} px)`;

        try {
            const blob = packSVGA();
            const url = URL.createObjectURL(blob);
            
            document.getElementById('playerStatus').textContent = StatusMessages.preview_loading;
            
            parser.load(url, (videoItem) => {
                if (player) {
                    player.stopAnimation(); 
                    player.clear();
                    player.setVideoItem(videoItem);
                    player.startAnimation(); 
                    document.getElementById('playerStatus').textContent = StatusMessages.preview_success;
                }
                URL.revokeObjectURL(url); 
            }, (err) => {
                document.getElementById('playerStatus').textContent = StatusMessages.preview_fail_player;
                console.error("SVGA Player load failed, details:", err);
                URL.revokeObjectURL(url);
            });
        } catch (e) {
            document.getElementById('playerStatus').textContent = StatusMessages.preview_fail_gen;
            console.error("Preview generation or packing error:", e);
        }
    }


    // --- Helper Functions ---
    function packSVGA() {
        const message = MovieEntity.create(currentMovieData);
        const encodedBuffer = MovieEntity.encode(message).finish();
        const deflatedData = pako.deflate(encodedBuffer);
        return new Blob([deflatedData], { type: "application/octet-stream" });
    }

    async function getImageDimensions(imgBytes) {
        return new Promise(resolve => {
            if (!imgBytes || imgBytes.length === 0) return resolve({ width: '0', height: '0' });
            
            const blob = new Blob([imgBytes], { type: 'image/png' }); 
            const url = URL.createObjectURL(blob);
            const img = new Image();
            
            img.onload = () => {
                URL.revokeObjectURL(url);
                resolve({ width: img.width, height: img.height });
            };
            img.onerror = () => {
                URL.revokeObjectURL(url);
                resolve({ width: '?', height: '?' });
            };
            img.src = url;
        });
    }
    
    window.downloadAsset = (event, key) => {
        event.preventDefault(); 
        const imgBytes = currentMovieData.images[key];
        if (!imgBytes) return;

        const blob = new Blob([imgBytes], { type: 'application/octet-stream' }); 
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${key}.png`; 
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url); 
    };

    // --- Render Asset List ---
    function renderAssetsList(imagesMap) {
        const container = document.getElementById('assetsList');
        container.innerHTML = '';
        if (!imagesMap || Object.keys(imagesMap).length === 0) {
            container.innerHTML = `<div class="placeholder">${StatusMessages.no_assets_placeholder}</div>`;
            return;
        }
        
        Object.keys(imagesMap).sort().forEach(key => {
            const imgBytes = imagesMap[key];
            const blob = new Blob([imgBytes], { type: 'image/png' });
            
            const imgUrl = URL.createObjectURL(blob);
            objectUrls[key] = imgUrl; 
            
            const div = document.createElement('div');
            div.className = 'asset-item';
            div.innerHTML = `
                <img src="${imgUrl}" class="asset-preview" data-key="${key}">
                <div class="asset-info">
                    <div class="asset-key">${key}</div>
                    <div class="asset-meta">${(imgBytes.length / 1024).toFixed(1)} KB | Dimensions: Calculating...</div>
                </div>
                <a href="#" onclick="downloadAsset(event, '${key}')" class="download-icon" title="Download Asset">
                    <svg fill="currentColor" width="20" height="20" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                </a>
                <label class="btn-upload-small" title="Replace Image">
                    Replace Asset
                    <input type="file" accept="image/*" onchange="handleReplace('${key}', this)">
                </label>
            `;
            container.appendChild(div);

            getImageDimensions(imgBytes).then(dim => {
                const metaDiv = div.querySelector('.asset-meta');
                metaDiv.textContent = 
                    `${(imgBytes.length / 1024).toFixed(1)} KB | Dimensions: ${dim.width}x${dim.height} px`;
            });
        });
    }

    window.handleReplace = async (key, inputElement) => {
        const file = inputElement.files[0];
        if (!file) return;

        const buffer = await file.arrayBuffer();
        const newBytes = new Uint8Array(buffer);
        
        currentMovieData.images[key] = newBytes;

        const blob = new Blob([newBytes], { type: 'image/png' });
        
        if (objectUrls[key]) {
            URL.revokeObjectURL(objectUrls[key]); 
        }
        const newUrl = URL.createObjectURL(blob);
        objectUrls[key] = newUrl; 

        const itemElement = inputElement.parentElement.parentElement;
        itemElement.querySelector('.asset-preview').src = newUrl;
        
        const metaDiv = itemElement.querySelector('.asset-meta');
        metaDiv.textContent = `${(newBytes.length / 1024).toFixed(1)} KB | Dimensions: Calculating... (Updated)`;

        getImageDimensions(newBytes).then(dim => {
            metaDiv.textContent = 
                `${(newBytes.length / 1024).toFixed(1)} KB | Dimensions: ${dim.width}x${dim.height} px (Updated)`;
        });

        setStatus('success', StatusMessages.replace_success(key));
        tryDynamicPreview(); 
    };

    document.getElementById('downloadBtn').addEventListener('click', () => {
        try {
            const blob = packSVGA();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `svga_replaced_${new Date().getTime()}.svga`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); 
            setStatus('success', StatusMessages.export_success);
        } catch(e) {
            setStatus('error', StatusMessages.export_fail(e.message));
            console.error("Export failed:", e);
        }
    });

</script>
<script src="pako.min.js"></script>
    
    <script src="protobuf.min.js"></script>
    
    <script src="svga.min.js"></script>

</body>
</html>
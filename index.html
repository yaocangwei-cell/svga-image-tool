<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>SVGA å›¾ç‰‡æ›¿æ¢å·¥å…· (æœ€ç»ˆç¨³å®šä¿®å¤ç‰ˆ V7 - å°ºå¯¸ä¸èƒŒæ™¯)</title>
    
    <script src="./protobuf.min.js"></script>
    <script src="./pako.min.js"></script>
    <script src="./svga.min.js"></script> 
    
    <style>
        /* --- æ•´ä½“å¸ƒå±€å’ŒåŸºç¡€æ ·å¼ --- */
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .main-area { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .status-bar { margin-bottom: 20px; padding: 15px; border-radius: 8px; font-weight: 600; display: none; }
        .status-error { background: #fff1f0; border: 1px solid #ffa39e; color: #cf1322; }
        .status-success { background: #f6ffed; border: 1px solid #b7eb8f; color: #389e0d; }
        .status-loading { background: #e6f7ff; border: 1px solid #91d5ff; color: #1890ff; }
        
        /* --- æ’­æ”¾å™¨åŒºåŸŸä¼˜åŒ– --- */
        #player-wrapper { 
            position: relative;
            /* V7 ä¿®æ­£: ç§»é™¤å›ºå®šé«˜åº¦ï¼Œå…è®¸å†…å®¹æ’‘å¼€ */
            height: auto; 
            min-height: 200px; /* ç¡®ä¿æœªåŠ è½½æ–‡ä»¶æ—¶æœ‰æœ€å°é«˜åº¦ */
            width: 100%;
            background-color: #fafafa; /* å¤–éƒ¨åŒºåŸŸèƒŒæ™¯è‰² */
            border: 2px dashed #e8e8e8; 
            border-radius: 8px; 
            margin-bottom: 20px;
            overflow: hidden; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: background-color 0.3s; 
        }
        
        /* æ‹–æ‹½æç¤ºæ ·å¼ (åˆå§‹çŠ¶æ€) */
        #drag-overlay {
            /* ... (ä¿æŒä¸å˜) ... */
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            z-index: 20; 
            pointer-events: none;
            color: #ccc;
        }
        #drag-overlay.hidden { display: none; }
        #drag-overlay.drag-over { 
            background: rgba(230, 247, 255, 0.9); 
            border: 4px solid #1890ff; 
        }

        /* SVGA Player å®é™…ç”»å¸ƒå®¹å™¨ */
        #playerCanvas { 
            /* V7 ä¿®æ­£: åˆå§‹å°ºå¯¸ä¸º 0ï¼Œé˜²æ­¢æ’‘å¼€çˆ¶å…ƒç´  */
            width: 0px; 
            height: 0px; 
            position: relative;
            /* V7 ä¿®æ­£: å°†èƒŒæ™¯è‰²è®¾ç½®åˆ°è¿™é‡Œï¼Œè®©å®ƒåªå¡«å……åŠ¨ç”»å®é™…å°ºå¯¸ */
            transition: background-color 0.3s; 
        }
        
        /* å¼ºåˆ¶è®© Canvas å…ƒç´ å……æ»¡å®¹å™¨ï¼Œç¡®ä¿æ¸²æŸ“å™¨èƒ½æ‰¾åˆ°æ­£ç¡®çš„å°ºå¯¸ */
        #playerCanvas canvas {
            width: 100% !important;
            height: 100% !important;
            display: block; /* ç§»é™¤ Canvas é»˜è®¤çš„è¡Œå†…å…ƒç´ é—´éš™ */
        }
        
        #playerStatus {
            position: absolute;
            top: 10px; left: 10px; font-size: 12px; color: #999; z-index: 10;
        }
        #fileDimensions { font-size: 14px; font-weight: normal; color: #999; }

        /* --- åˆ—è¡¨æ ·å¼ (ä¿æŒä¸å˜) --- */
        .color-swatch {
            width: 30px; height: 30px; border-radius: 4px; cursor: pointer; 
            transition: transform 0.1s, box-shadow 0.1s; display: inline-block;
        }
        .color-swatch:hover { transform: scale(1.1); box-shadow: 0 0 5px rgba(0,0,0,0.3); }
        .color-swatch[data-color="#FFFFFF"] { border: 1px solid #ccc; } 

        .assets-list { border: 1px solid #eee; border-radius: 8px; }
        .asset-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; background: #fff; position: relative; }
        .asset-preview { width: 50px; height: 50px; object-fit: contain; background: #eee; border-radius: 4px; margin-right: 15px; border: 1px solid #ddd; }
        .asset-info { flex: 1; }
        .asset-key { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .asset-meta { font-size: 12px; color: #999; }
        
        .btn-upload-small { padding: 6px 12px; background: #faad14; color: white; font-size: 12px; border-radius: 4px; cursor: pointer; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: #1890ff; color: white; }
        .btn-download { background: #52c41a; color: white; }
        input[type=file] { display: none; }
    </style>
</head>
<body>

<div class="main-area">
    <h2 style="margin-top:0">SVGA å›¾ç‰‡æ›¿æ¢å·¥å…· (æœ€ç»ˆç¨³å®šä¿®å¤ç‰ˆ V7)</h2>
    
    <div id="statusBar" class="status-bar"></div>

    <div class="btn-group">
        <label class="btn btn-primary">
            ğŸ“‚ åŠ è½½ SVGA æ–‡ä»¶
            <input type="file" id="svgaInput" accept=".svga">
        </label>
        <button id="downloadBtn" class="btn btn-download" disabled>ğŸ’¾ å¯¼å‡ºæ–°æ–‡ä»¶</button>
    </div>

    <h3>åŠ¨æ€é¢„è§ˆ (æ–‡ä»¶å°ºå¯¸: <span id="fileDimensions">æœªåŠ è½½</span>)</h3>
    <div id="player-wrapper">
        <div id="drag-overlay">
            <svg fill="currentColor" width="48" height="48" viewBox="0 0 24 24" style="margin-bottom: 10px;"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11zM10.71 14.29l1.59 1.59V12h1.4v3.88l1.59-1.59.99.99-3 3-3-3 .99-.99z"/></svg>
            <span style="font-size: 16px;">ä½“éªŒé¢„è§ˆ SVGA åŠ¨ç”»ï¼Œè¯·å°†æ–‡ä»¶æ‹–æ‹½åˆ°æ­¤åŒºåŸŸ</span>
            <div style="font-size:12px; margin-top:10px;">è¯·æ‰“å¼€æ§åˆ¶å° (F12) æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯</div>
        </div>

        <div id="playerCanvas">
             </div>
        <span id="playerStatus" style="color:#ccc">ç­‰å¾…æ–‡ä»¶åŠ è½½...</span>
    </div>
    
    <div id="color-selector" style="display:flex; justify-content:center; gap:10px; margin-bottom: 20px;">
        <span class="color-swatch" data-color="#000000" style="background:#000000" title="é»‘è‰²"></span>
        <span class="color-swatch" data-color="#FFFFFF" style="background:#FFFFFF" title="ç™½è‰²"></span>
        <span class="color-swatch" data-color="#3D82FF" style="background:#3D82FF" title="è“è‰²"></span>
        <span class="color-swatch" data-color="#55C464" style="background:#55C464" title="ç»¿è‰²"></span>
        <span class="color-swatch" data-color="#FFDD33" style="background:#FFDD33" title="é»„è‰²"></span>
        <span class="color-swatch" data-color="#FF4040" style="background:#FF4040" title="çº¢è‰²"></span>
    </div>

    <h3>å›¾ç‰‡ç´ æåˆ—è¡¨ (å«å°ºå¯¸ã€ä¸‹è½½ã€æ›¿æ¢)</h3>
    <div class="assets-list" id="assetsList">
        <div style="padding:20px; text-align:center; color:#999;">ç­‰å¾…æ–‡ä»¶åŠ è½½...</div>
    </div>
</div>

<script>
    // --- Protobuf å®šä¹‰ (ä¿æŒä¸å˜) ---
    const officialProtoDefinition = `
    syntax = "proto3";
    package com.opensource.svga;
    message MovieParams { float viewBoxWidth = 1; float viewBoxHeight = 2; int32 fps = 3; int32 frames = 4; }
    message Rect { float x = 1; float y = 2; float width = 3; float height = 4; }
    message Transform { float a = 1; float b = 2; float c = 3; float d = 4; float tx = 5; float ty = 6; }
    message Point { float x = 1; float y = 2; }
    message Layout { float x = 1; float y = 2; float width = 3; float height = 4; }
    message ShapeEntity { enum ShapeType { SHAPE = 0; RECT = 1; ROUNDED_RECT = 2; ELLIPSE = 3; POLYGON = 4; TEXT = 5; } ShapeType type = 1; string args = 2; ShapeStyle styles = 3; Transform transform = 4; }
    message ShapeStyle { float fillR = 1; float fillG = 2; float fillB = 3; float fillA = 4; float strokeR = 5; float strokeG = 6; float strokeB = 7; float strokeA = 8; float strokeWidth = 9; float miterLimit = 10; repeated float lineDash = 11; int32 lineCap = 12; int32 lineJoin = 13; }
    message FrameEntity { float alpha = 1; Layout layout = 2; Transform transform = 3; string clipPath = 4; repeated ShapeEntity shapes = 5; repeated string events = 6; repeated string filters = 7; }
    message SpriteEntity { string imageKey = 1; repeated FrameEntity frames = 2; string zPosition = 3; repeated string events = 4; }
    message AudioEntity { string audioKey = 1; int32 startFrame = 2; int32 endFrame = 3; int32 startTime = 4; int32 totalTime = 5; }
    message MovieEntity { string version = 1; MovieParams params = 2; map<string, bytes> images = 3; repeated SpriteEntity sprites = 4; repeated AudioEntity audios = 5; }
    `;

    let MovieEntity = null;
    let currentMovieData = null; 
    let player = null; 
    let parser = null;
    const objectUrls = {};
    let currentBgColor = "#FFFFFF"; // V7 ä¿®æ­£: è®°å½•å½“å‰èƒŒæ™¯è‰²

    function setStatus(type, msg) {
        console.log(`[Status] ${type}: ${msg}`);
        const el = document.getElementById('statusBar');
        el.style.display = 'block';
        el.className = `status-bar status-${type}`;
        el.innerHTML = msg;
    }

    // --- æ ¸å¿ƒåˆå§‹åŒ–é€»è¾‘ ---
    window.onload = () => {
        console.log("åˆå§‹åŒ–å¼€å§‹...");
        
        if (typeof protobuf === 'undefined' || typeof pako === 'undefined' || typeof SVGA === 'undefined') {
            const missing = [];
            if (typeof protobuf === 'undefined') missing.push('protobuf.min.js');
            if (typeof pako === 'undefined') missing.push('pako.min.js');
            if (typeof SVGA === 'undefined') missing.push('svga.min.js');
            
            setStatus('error', `âŒ å¯åŠ¨å¤±è´¥ï¼šç¼ºå°‘ä»¥ä¸‹æ ¸å¿ƒæ–‡ä»¶ï¼š${missing.join(', ')}ã€‚è¯·ç¡®ä¿æ–‡ä»¶å·²ä¸‹è½½å¹¶æ”¾åœ¨ index.html åŒçº§ç›®å½•ä¸‹ã€‚`);
            return;
        }
        
        try {
            const parsed = protobuf.parse(officialProtoDefinition, { keepCase: true });
            MovieEntity = parsed.root.lookupType("com.opensource.svga.MovieEntity");
            parser = new SVGA.Parser();
            console.log("SVGA.Parser åˆå§‹åŒ–æˆåŠŸã€‚");

            // ç»‘å®šé¢œè‰²é€‰æ‹©å™¨äº‹ä»¶
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.addEventListener('click', (e) => {
                    const color = e.target.getAttribute('data-color');
                    currentBgColor = color; // V7 ä¿®æ­£: æ›´æ–°å…¨å±€èƒŒæ™¯è‰²å˜é‡
                    // V7 ä¿®æ­£: å°†èƒŒæ™¯è‰²åº”ç”¨åˆ°å®é™…ç”»å¸ƒå®¹å™¨
                    document.getElementById('playerCanvas').style.backgroundColor = color; 
                    setStatus('success', `âœ… èƒŒæ™¯è‰²å·²è®¾ç½®ä¸º ${color}ã€‚`);
                });
            });

            // åˆå§‹åŒ–æ—¶è®¾ç½®é»˜è®¤èƒŒæ™¯è‰²
            document.getElementById('playerCanvas').style.backgroundColor = currentBgColor;

            // ç»‘å®šæ–‡ä»¶äº‹ä»¶ (æ‹–æ‹½å’Œæ–‡ä»¶é€‰æ‹©)
            const dropArea = document.getElementById('player-wrapper');
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                document.getElementById('drag-overlay').classList.add('drag-over');
            });
            dropArea.addEventListener('dragleave', (e) => {
                document.getElementById('drag-overlay').classList.remove('drag-over');
            });
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                document.getElementById('drag-overlay').classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file) {
                    const extension = file.name.split('.').pop().toLowerCase();
                    if (extension === 'svga') { 
                        loadFile(file);
                    } else {
                        setStatus('error', 'âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·æ‹–å…¥ .svga æ–‡ä»¶ã€‚');
                    }
                }
            });

            document.getElementById('svgaInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const extension = file.name.split('.').pop().toLowerCase();
                    if (extension === 'svga') {
                        loadFile(file);
                    } else {
                        setStatus('error', 'âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·é€‰æ‹© .svga æ–‡ä»¶ã€‚');
                    }
                }
            });


            setStatus('success', 'âœ… æ ¸å¿ƒç»„ä»¶åŠ è½½æˆåŠŸï¼Œç­‰å¾…æ–‡ä»¶å¯¼å…¥ã€‚');
        } catch (e) {
            setStatus('error', 'âŒ åˆå§‹åŒ–å¤±è´¥ (Protobuf/SVGA)ï¼š' + e.message);
            console.error("åˆå§‹åŒ–é”™è¯¯:", e);
        }
    };
    
    // --- æ–‡ä»¶åŠ è½½ä¸è§£æé€»è¾‘ ---
    async function loadFile(file) {
        setStatus('loading', `â³ æ­£åœ¨åŠ è½½å¹¶è§£ææ–‡ä»¶ï¼š${file.name}...`);
        document.getElementById('downloadBtn').disabled = true;
        document.getElementById('assetsList').innerHTML = '<div style="padding:20px; text-align:center; color:#999;">æ­£åœ¨è§£ææ–‡ä»¶...</div>';
        document.getElementById('playerStatus').textContent = 'åŠ è½½ä¸­...';
        document.getElementById('fileDimensions').textContent = 'è®¡ç®—ä¸­...';
        
        document.getElementById('drag-overlay').classList.add('hidden');
        
        // 1. æ¸…ç†æ—§æ’­æ”¾å™¨çš„DOMï¼Œç¡®ä¿å®¹å™¨å¹²å‡€
        document.getElementById('playerCanvas').innerHTML = ''; 
        // V7 ä¿®æ­£: æ¸…ç†å°ºå¯¸ï¼Œç­‰å¾…æ–°æ–‡ä»¶å°ºå¯¸
        document.getElementById('playerCanvas').style.width = '0px'; 
        document.getElementById('playerCanvas').style.height = '0px'; 
        
        // 2. é”€æ¯æ—§æ’­æ”¾å™¨å®ä¾‹
        if (player) {
            player.stopAnimation();
            player.clear();
        }

        // 3. é‡æ–°åˆ›å»ºæ’­æ”¾å™¨å®ä¾‹ï¼Œç»‘å®šåˆ°å¹²å‡€çš„DOMå®¹å™¨ä¸Š
        try {
            // V7 ä¿®æ­£: é‡æ–°åˆ›å»ºæ’­æ”¾å™¨æ—¶ï¼Œä½¿ç”¨ Canvas æ¸²æŸ“å™¨
            player = new SVGA.Player('#playerCanvas', { renderer: 'canvas' }); 
            // V7 ä¿®æ­£: è®¾ç½® contentMode ä¸º Fill æˆ– AspectFillï¼Œä»¥å®ç°ä¸ç¼©æ”¾çš„æ•ˆæœ
            player.setContentMode("Fill"); // Fill è¡¨ç¤ºä¸ä¿æŒæ¯”ä¾‹ï¼Œç›´æ¥å¡«å……å®¹å™¨ï¼Œç”±äºå®¹å™¨å°ºå¯¸ç­‰äºåŠ¨ç”»å°ºå¯¸ï¼Œæ‰€ä»¥å¯ä»¥å®ç°1:1æ˜¾ç¤º
            player.loops = 0; 
            console.log("SVGA.Player å®ä¾‹å·²é‡æ–°åˆ›å»ºã€‚");
        } catch(e) {
            setStatus('error', 'âŒ SVGA Player é‡æ–°åˆå§‹åŒ–å¤±è´¥ï¼š' + e.message);
            console.error("SVGA Player é‡æ–°åˆå§‹åŒ–é”™è¯¯:", e);
            document.getElementById('drag-overlay').classList.remove('hidden'); 
            return;
        }


        try {
            const buffer = await file.arrayBuffer();
            let inflatedData;
            
            try {
                inflatedData = pako.inflate(new Uint8Array(buffer));
            } catch (err) {
                inflatedData = new Uint8Array(buffer);
            }

            currentMovieData = MovieEntity.decode(inflatedData);
            
            setStatus('success', `âœ… æ–‡ä»¶è§£ææˆåŠŸï¼åŒ…å« ${Object.keys(currentMovieData.images || {}).length} å¼ å›¾ç‰‡ã€‚`);

            renderAssetsList(currentMovieData.images);
            tryDynamicPreview(); 

            document.getElementById('downloadBtn').disabled = false;

        } catch (err) {
            setStatus('error', `âŒ æ ¸å¿ƒè§£ç å¤±è´¥ã€‚è¯·ç¡®è®¤æ–‡ä»¶æ˜¯å¦ä¸ºæ ‡å‡† SVGA æ ¼å¼ã€‚æŠ€æœ¯ç»†èŠ‚: ${err.message}`);
            console.error("Protobuf è§£ç æˆ–æ–‡ä»¶è¯»å–é”™è¯¯:", err);
            document.getElementById('playerStatus').textContent = 'æ–‡ä»¶åŠ è½½å¤±è´¥';
            document.getElementById('assetsList').innerHTML = '<div style="padding:20px; text-align:center; color:#cf1322;">æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ã€‚</div>';
            document.getElementById('drag-overlay').classList.remove('hidden'); 
        }
    }


    // --- åŠ¨æ€é¢„è§ˆ ---
    function tryDynamicPreview() {
        if (!currentMovieData || !player) return; 
        
        player.stopAnimation();
        player.clear(); 
        
        const { viewBoxWidth, viewBoxHeight } = currentMovieData.params;
        
        // V7 å…³é”®ä¿®æ­£: åŠ¨æ€è®¾ç½®æ’­æ”¾å™¨å®¹å™¨çš„å°ºå¯¸
        const playerCanvas = document.getElementById('playerCanvas');
        playerCanvas.style.width = `${viewBoxWidth}px`;
        playerCanvas.style.height = `${viewBoxHeight}px`;

        document.getElementById('fileDimensions').textContent = `${viewBoxWidth} x ${viewBoxHeight} px`;

        try {
            const blob = packSVGA();
            const url = URL.createObjectURL(blob);
            
            document.getElementById('playerStatus').textContent = 'åŠ è½½é¢„è§ˆä¸­...';
            
            parser.load(url, (videoItem) => {
                if (player) {
                    player.stopAnimation(); 
                    player.clear();
                    
                    // ç¡®ä¿ Canvas å…ƒç´ å·²ç»åˆ›å»ºå¹¶ä¸”å°ºå¯¸æ­£ç¡®
                    player.setVideoItem(videoItem);
                    player.startAnimation(); 
                    document.getElementById('playerStatus').textContent = 'åŠ¨æ€é¢„è§ˆæˆåŠŸ';
                }
                URL.revokeObjectURL(url); 
            }, (err) => {
                document.getElementById('playerStatus').textContent = 'åŠ¨æ€é¢„è§ˆå¤±è´¥ (SVGA Player åŠ è½½é”™è¯¯)';
                console.error("SVGA Player åŠ è½½å¤±è´¥ï¼Œè¯¦ç»†ä¿¡æ¯:", err);
                URL.revokeObjectURL(url);
            });
        } catch (e) {
            document.getElementById('playerStatus').textContent = 'é¢„è§ˆç”Ÿæˆé”™è¯¯';
            console.error("é¢„è§ˆç”Ÿæˆæˆ–æ‰“åŒ…é”™è¯¯:", e);
        }
    }


    // --- è¾…åŠ©å‡½æ•° (ä¿æŒä¸å˜) ---
    function packSVGA() {
        const message = MovieEntity.create(currentMovieData);
        const encodedBuffer = MovieEntity.encode(message).finish();
        const deflatedData = pako.deflate(encodedBuffer);
        return new Blob([deflatedData], { type: "application/octet-stream" });
    }

    async function getImageDimensions(imgBytes) {
        // ... (ä¿æŒä¸å˜) ...
        return new Promise(resolve => {
            if (!imgBytes || imgBytes.length === 0) return resolve({ width: '0', height: '0' });
            
            const blob = new Blob([imgBytes], { type: 'image/png' }); 
            const url = URL.createObjectURL(blob);
            const img = new Image();
            
            img.onload = () => {
                URL.revokeObjectURL(url);
                resolve({ width: img.width, height: img.height });
            };
            img.onerror = () => {
                URL.revokeObjectURL(url);
                resolve({ width: '?', height: '?' });
            };
            img.src = url;
        });
    }
    
    window.downloadAsset = (event, key) => {
        // ... (ä¿æŒä¸å˜) ...
        event.preventDefault(); 
        const imgBytes = currentMovieData.images[key];
        if (!imgBytes) return;

        const blob = new Blob([imgBytes], { type: 'application/octet-stream' }); 
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${key}.png`; 
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url); 
    };

    function renderAssetsList(imagesMap) {
        // ... (ä¿æŒä¸å˜) ...
        const container = document.getElementById('assetsList');
        container.innerHTML = '';
        if (!imagesMap || Object.keys(imagesMap).length === 0) {
            container.innerHTML = '<div style="padding:20px; text-align:center;">æ­¤æ–‡ä»¶æ²¡æœ‰å›¾ç‰‡èµ„æº</div>';
            return;
        }
        
        Object.keys(imagesMap).sort().forEach(key => {
            const imgBytes = imagesMap[key];
            const blob = new Blob([imgBytes], { type: 'image/png' });
            
            const imgUrl = URL.createObjectURL(blob);
            objectUrls[key] = imgUrl; 
            
            const div = document.createElement('div');
            div.className = 'asset-item';
            div.innerHTML = `
                <img src="${imgUrl}" class="asset-preview" data-key="${key}">
                <div class="asset-info">
                    <div class="asset-key">${key}</div>
                    <div class="asset-meta">${(imgBytes.length / 1024).toFixed(1)} KB | å°ºå¯¸: è®¡ç®—ä¸­...</div>
                </div>
                <a href="#" onclick="downloadAsset(event, '${key}')" class="download-icon" title="ä¸‹è½½ç´ æ">
                    <svg fill="currentColor" width="16" height="16" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                </a>
                <label class="btn-upload-small">
                    æ›¿æ¢å›¾ç‰‡
                    <input type="file" accept="image/*" onchange="handleReplace('${key}', this)">
                </label>
            `;
            container.appendChild(div);

            getImageDimensions(imgBytes).then(dim => {
                const metaDiv = div.querySelector('.asset-meta');
                metaDiv.textContent = 
                    `${(imgBytes.length / 1024).toFixed(1)} KB | å°ºå¯¸: ${dim.width}x${dim.height} px`;
            });
        });
    }

    window.handleReplace = async (key, inputElement) => {
        const file = inputElement.files[0];
        if (!file) return;

        const buffer = await file.arrayBuffer();
        const newBytes = new Uint8Array(buffer);
        
        currentMovieData.images[key] = newBytes;

        const blob = new Blob([newBytes], { type: 'image/png' });
        
        if (objectUrls[key]) {
            URL.revokeObjectURL(objectUrls[key]); 
        }
        const newUrl = URL.createObjectURL(blob);
        objectUrls[key] = newUrl; 

        const itemElement = inputElement.parentElement.parentElement;
        itemElement.querySelector('.asset-preview').src = newUrl;
        
        const metaDiv = itemElement.querySelector('.asset-meta');
        metaDiv.textContent = `${(newBytes.length / 1024).toFixed(1)} KB | å°ºå¯¸: è®¡ç®—ä¸­... (å·²æ›´æ–°)`;

        getImageDimensions(newBytes).then(dim => {
            metaDiv.textContent = 
                `${(newBytes.length / 1024).toFixed(1)} KB | å°ºå¯¸: ${dim.width}x${dim.height} px (å·²æ›´æ–°)`;
        });

        setStatus('success', `âœ… å›¾ç‰‡ ${key} æ›¿æ¢æˆåŠŸï¼æ­£åœ¨æ›´æ–°åŠ¨æ€é¢„è§ˆ...`);
        tryDynamicPreview(); 
    };

    document.getElementById('downloadBtn').addEventListener('click', () => {
        try {
            const blob = packSVGA();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fixed_${new Date().getTime()}.svga`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); 
            setStatus('success', 'âœ… æ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼');
        } catch(e) {
            setStatus('error', 'âŒ æ–‡ä»¶å¯¼å‡ºå¤±è´¥ï¼š' + e.message);
            console.error("å¯¼å‡ºå¤±è´¥:", e);
        }
    });

</script>

</body>
</html>
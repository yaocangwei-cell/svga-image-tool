<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SVGA Asset Replacement Tool | V16.1</title>
    
    <style>
        /* =========================================
           Ê†∏ÂøÉÊ†∑Âºè
           ========================================= */
        body {
            font-family: 'Inter', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif; 
            margin: 0; padding: 0;
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh;
            background-color: #0d0d0d; color: #e0e0e0; 
            line-height: 1.6; overflow-x: hidden; position: relative;
        }

        /* ËÉåÊôØÁΩëÊ†ºË£ÖÈ•∞ */
        body::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%231a1a1a' fill-opacity='0.6' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
            background-repeat: repeat; opacity: 0.8; pointer-events: none; z-index: -1; 
        }

        .main-area {
            max-width: 960px; width: 95%; margin: 40px auto;
            background-color: #1a1a1a; border-radius: 12px; 
            box-shadow: 0 10px 40px rgba(0, 255, 128, 0.05); 
            border: 1px solid rgba(30, 255, 128, 0.1); 
            padding: 35px; animation: fadeIn 0.8s ease-out;
            position: relative; z-index: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Header Section (New) --- */
        .header-container { text-align: center; margin-bottom: 30px; }
        
        h1 {
            color: #00ff80; font-size: 2.5em; margin: 0 0 10px 0;
            font-weight: 800; letter-spacing: 1px; 
            text-shadow: 0 0 15px rgba(0, 255, 128, 0.4); 
        }
        
        .header-meta {
            display: flex; justify-content: center; align-items: center; gap: 15px;
            font-size: 14px; color: #666; font-family: 'Consolas', monospace;
        }
        
        .lang-btn {
            background: transparent; border: 1px solid #444; color: #888;
            padding: 2px 8px; border-radius: 4px; cursor: pointer;
            transition: all 0.3s; font-size: 12px;
        }
        .lang-btn:hover { border-color: #00ff80; color: #00ff80; }

        h3 {
            color: #00ff80; font-size: 1.4em; margin-top: 35px; margin-bottom: 18px;
            border-bottom: 1px solid rgba(0, 255, 128, 0.2); padding-bottom: 10px; font-weight: 600;
        }

        /* --- Player Area --- */
        #player-wrapper { 
            position: relative; height: auto; min-height: 350px; width: 100%;
            background-color: #2a2a2a; border: 2px dashed #4a4a4a; border-radius: 10px; 
            margin-bottom: 25px; overflow: hidden; display: flex; align-items: center; justify-content: center;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.4); cursor: pointer; transition: border-color 0.3s;
        }
        #player-wrapper:hover { border-color: #00ff80; }
        
        /* ÈÄèÊòéËÉåÊôØÊ£ãÁõòÊ†ºÊ†∑Âºè */
        .bg-transparent-pattern {
            background-image: 
                linear-gradient(45deg, #2a2a2a 25%, transparent 25%), 
                linear-gradient(-45deg, #2a2a2a 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #2a2a2a 75%), 
                linear-gradient(-45deg, transparent 75%, #2a2a2a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #1a1a1a; /* Base dark */
        }

        #drag-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: rgba(26, 26, 26, 0.9); z-index: 20; pointer-events: none;
            color: #b0b0b0; text-align: center;
        }
        #drag-overlay.hidden { display: none; }
        #drag-overlay.drag-over { background-color: rgba(0, 255, 128, 0.15); border: none; color: #00ff80; }
        #drag-overlay svg { margin-bottom: 15px; color: #00ff80; width: 60px; height: 60px; } 

        #playerCanvas { width: 0px; height: 0px; position: relative; border-radius: 8px; overflow: hidden; }
        #playerCanvas canvas { width: 100% !important; height: 100% !important; display: block; }

        /* --- Color Selector --- */
        #color-selector {
            display: flex; justify-content: center; gap: 12px; margin-bottom: 30px;
            padding: 10px 0; border-top: 1px solid rgba(0, 255, 128, 0.1); border-bottom: 1px solid rgba(0, 255, 128, 0.1);
        }
        .color-swatch {
            width: 35px; height: 35px; border-radius: 50%; cursor: pointer; 
            transition: transform 0.2s ease; display: inline-block; border: 2px solid transparent;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .color-swatch:hover { transform: scale(1.15); border-color: #00ff80; }
        .color-swatch[data-color="#FFFFFF"] { border: 2px solid #666; } 
        
        /* ÈÄèÊòéÈÄâÈ°πÁöÑÁâπÊÆäÊ†∑Âºè */
        .color-swatch.is-transparent {
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 8px 8px;
            background-color: #fff;
            border: 2px solid #555;
        }

        /* --- Assets List --- */
        .assets-list { 
            background-color: #222; border: 1px solid #4a4a4a; border-radius: 10px; 
            padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 15px; max-height: 600px; overflow-y: auto;
        }
        .asset-item { 
            display: flex; flex-direction: column; align-items: center; text-align: center;
            padding: 10px; background-color: #1a1a1a; border: 1px solid #333;
            border-radius: 8px; transition: all 0.2s ease; position: relative;
        }
        .asset-item:hover { transform: translateY(-2px); border-color: #00ff80; background-color: #252525; }
        .asset-preview-wrapper {
            position: relative; width: 100%; height: 90px; margin-bottom: 8px;
            background-color: #2a2a2a; border-radius: 6px; border: 1px solid #444;
            display: flex; align-items: center; justify-content: center;
        }
        .asset-preview { max-width: 100%; max-height: 100%; object-fit: contain; }
        .asset-info { width: 100%; margin-bottom: 8px; }
        .asset-key { font-weight: 700; font-size: 13px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
        .asset-meta { font-size: 11px; color: #888; }
        .download-icon { 
            position: absolute; top: 2px; right: 2px; color: rgba(255,255,255,0.7); 
            background: rgba(0,0,0,0.6); border-radius: 4px; padding: 4px; cursor: pointer; transition: all 0.2s;
        }
        .download-icon:hover { color: #00ff80; background: #000; }
        .download-icon svg { width: 14px; height: 14px; display: block; }
        .btn-upload-small { 
            width: 100%; padding: 6px 0; background: #333; border: 1px solid #555;
            color: #ccc; font-size: 12px; border-radius: 4px; cursor: pointer; 
            transition: all 0.2s ease; text-align: center; display: block; 
        }
        .btn-upload-small:hover { background: #00ff80; border-color: #00ff80; color: #000; font-weight: bold; }
        .placeholder { grid-column: 1 / -1; padding: 40px; text-align: center; color: #666; font-size: 1em; }

        /* --- Batch Section --- */
        .batch-section {
            margin-top: 40px; background-color: #222222;
            border: 1px solid #00ff80; border-radius: 10px; padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 255, 128, 0.05);
        }
        .batch-drop-zone {
            border: 2px dashed #555; border-radius: 8px; padding: 40px;
            text-align: center; color: #888; cursor: pointer; transition: all 0.3s;
            background: rgba(0, 0, 0, 0.2);
        }
        .batch-drop-zone:hover, .batch-drop-zone.drag-over {
            border-color: #00ff80; background: rgba(0, 255, 128, 0.05); color: #fff;
        }
        .batch-icon { font-size: 40px; margin-bottom: 10px; display: block; opacity: 0.7; }
        .log-console {
            background: #000; color: #00ff80; font-family: 'Consolas', monospace; font-size: 12px;
            padding: 15px; border-radius: 6px; margin-top: 15px; max-height: 150px;
            overflow-y: auto; border: 1px solid #333; display: none; white-space: pre-wrap;
        }
        .batch-hint { font-size: 12px; color: #666; margin-top: 15px; border-top: 1px solid #444; padding-top: 10px; }

        /* --- Status Bar --- */
        .status-bar {
            margin-bottom: 25px; padding: 15px 20px;
            border-radius: 8px; font-weight: 600; display: none; font-size: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); border: 1px solid; 
        }
        .status-error { background-color: #3d1b1b; border-color: #7b2929; color: #ff8c8c; } 
        .status-success { background-color: #1b3d2b; border-color: #297b4a; color: #8cffad; } 

        /* --- Export Button (Fancy) --- */
        .btn-download-container {
            position: relative; width: 100%; display: flex; justify-content: center; margin-top: 40px;
        }
        .btn-download { 
            position: relative;
            background: linear-gradient(45deg, #00e676, #00b368); 
            color: #1a1a1a; border: none; overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 255, 128, 0.4); 
            font-weight: 700; width: 50%; text-align: center; padding: 14px 28px; 
            border-radius: 30px; cursor: pointer; transition: all 0.3s ease; z-index: 1;
        }
        .btn-download:disabled { opacity: 0.5; cursor: not-allowed; background: #333; color: #555; box-shadow: none; }
        
        /* Ê∏êÂèòÊ∫∂Ëß£‰∏éÂÖâÊïà */
        .btn-download::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, #00ff80, #00b368, #00ffd5, #00ff80);
            background-size: 400%; z-index: -1; opacity: 0; transition: opacity 0.5s;
            border-radius: 30px;
        }
        
        .btn-download:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(0, 255, 128, 0.8);
            color: #000;
        }
        
        .btn-download:hover:not(:disabled)::before {
            opacity: 1;
            animation: glowing 3s linear infinite;
        }

        @keyframes glowing {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Èº†Ê†áÁÅ´Ëä±Á≤íÂ≠ê */
        .particle {
            position: absolute; pointer-events: none; border-radius: 50%;
            animation: particle-fly 0.8s ease-out forwards; z-index: 99;
        }
        @keyframes particle-fly {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--mx), var(--my)) scale(0); opacity: 0; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; border-left: 1px solid #333; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 5px; border: 2px solid #1a1a1a; }
        ::-webkit-scrollbar-thumb:hover { background: #00ff80; }

        /* Meta Overlay */
        #fileMetaOverlay {
            position: absolute; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px); padding: 8px 12px; border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.15); color: #ddd; font-family: Consolas, monospace;
            font-size: 12px; z-index: 50; display: none; text-align: right; line-height: 1.5; pointer-events: none;
        }
        #fileMetaOverlay b { color: #fff; }
        .mem-normal { color: #8cffad; }
        .mem-warning { color: #ff4d4d !important; font-weight: bold; border-bottom: 1px dashed #ff4d4d; }

    </style>
</head>
<body>

<div class="main-area">
    
    <div class="header-container">
        <h1 data-key="title">SVGA Animation Asset Replacement Tool</h1>
        <div class="header-meta">
            <span>V16.1 ‚Ä¢ Dev: cang</span>
            <button class="lang-btn" onclick="toggleLanguage()" id="langBtn">ÂàáÊç¢‰∏≠Êñá</button>
        </div>
    </div>
    
    <input type="file" id="svgaInput" accept=".svga" style="display: none;">

    <h3 style="margin-top:0" data-key="sectionPreview">Animation Preview</h3>
    
    <div id="player-wrapper">
        <div id="drag-overlay">
            <svg fill="currentColor" width="60" height="60" viewBox="0 0 24 24" style="margin-bottom: 15px;"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11zM10.71 14.29l1.59 1.59V12h1.4v3.88l1.59-1.59.99.99-3 3-3-3 .99-.99z"/></svg>
            <span data-key="dragTip">Drag & Drop SVGA file (or Click to Load)</span>
        </div>

        <div id="fileMetaOverlay"></div> 

        <div id="playerCanvas"></div>
        <span id="playerStatus" style="color:#ccc; display:none;">Loading...</span>
    </div>

    <div id="statusBar" class="status-bar"></div>
    
    <h3 data-key="sectionBg">Background Color</h3>
    <div id="color-selector">
        <span class="color-swatch is-transparent" data-color="transparent" title="Transparent"></span>
        
        <span class="color-swatch" data-color="#000000" style="background:#000000" title="Black"></span>
        <span class="color-swatch" data-color="#FFFFFF" style="background:#FFFFFF" title="White"></span>
        <span class="color-swatch" data-color="#3D82FF" style="background:#3D82FF" title="Blue"></span>
        <span class="color-swatch" data-color="#55C464" style="background:#55C464" title="Green"></span>
        <span class="color-swatch" data-color="#FFDD33" style="background:#FFDD33" title="Yellow"></span>
        <span class="color-swatch" data-color="#FF4040" style="background:#FF4040" title="Red"></span>
        <span class="color-swatch" data-color="#F2F2F2" style="background:#F2F2F2" title="Light Gray"></span>
        <span class="color-swatch" data-color="#E0E0E0" style="background:#E0E0E0" title="Medium Gray"></span>
    </div>

    <h3 data-key="sectionAssets">Asset List</h3>
    <div class="assets-list" id="assetsList">
        <div class="placeholder" data-key="placeholder">Upload an SVGA file to display the asset list here.</div>
    </div>

    <div class="batch-section">
        <h3 style="margin-top:0; border:none; color:#00ff80;" data-key="batchTitle">üöÄ Batch Frame Replacement</h3>
        
        <div class="batch-drop-zone" id="batchDropZone">
            <span class="batch-icon">üìÇ</span>
            <div style="font-size: 16px;">
                <b data-key="batchDrag">Drag images here to Replace All</b><br>
                <span style="font-size:14px; color:#888;" data-key="batchClick">Or <b>Click Here</b> to select folder</span>
            </div>
            
            <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 10px; align-items: center;">
                <div id="sortOptionsWrapper" style="padding: 8px 15px; background: rgba(0,0,0,0.3); border-radius: 6px; text-align: left; display: inline-block;">
                    <div style="color: #00ff80; font-size: 12px; margin-bottom: 5px; font-weight:bold;" data-key="sortMode">1. Sorting Mode:</div>
                    <label style="margin-right: 15px; cursor: pointer; color: #e0e0e0; font-size: 13px;">
                        <input type="radio" name="sortMode" value="name" checked> <span data-key="sortName">By Name</span>
                    </label>
                    <label style="cursor: pointer; color: #e0e0e0; font-size: 13px;">
                        <input type="radio" name="sortMode" value="timeline"> <span data-key="sortTime">By Playback Order</span>
                    </label>
                </div>

                <div style="padding: 8px 15px; background: rgba(0,0,0,0.3); border-radius: 6px; text-align: left; display: inline-block;">
                    <div style="color: #ffcc00; font-size: 12px; margin-bottom: 5px; font-weight:bold;" data-key="optMode">2. Optimization:</div>
                    <label style="cursor: pointer; color: #e0e0e0; font-size: 13px;" title="Use UPNG algorithm to reduce PNG size significantly">
                        <input type="checkbox" id="compressToggle" checked> <span data-key="optUPNG">Enable PNG Compression (UPNG)</span>
                    </label>
                </div>
            </div>

            <div class="batch-hint" style="font-size:12px; color:#666; margin-top:15px;" data-key="batchTip">
                <b>Tip:</b> If SVGA plays with wrong frames, try "By Playback Order".
            </div>
        </div>
        
        <input type="file" id="batchFolderInput" webkitdirectory directory multiple style="display:none">
        <div class="log-console" id="batchLog"></div>
    </div>

    <div class="btn-download-container">
        <button id="downloadBtn" class="btn btn-download" disabled>
            <svg fill="currentColor" width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 8px;"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            <span data-key="btnExport">Export New File</span>
        </button>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.4/dist/protobuf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/svgaplayerweb@2.3.1/build/svga.min.js"></script>

<script>
    // --- 1. Internationalization (I18n) ---
    const i18n = {
        en: {
            title: "SVGA Animation Asset Replacement Tool",
            sectionPreview: "Animation Preview",
            dragTip: "Drag & Drop SVGA file (or Click to Load)",
            sectionBg: "Background Color",
            sectionAssets: "Asset List",
            placeholder: "Upload an SVGA file to display the asset list here.",
            batchTitle: "üöÄ Batch Frame Replacement",
            batchDrag: "Drag images here to Replace All",
            batchClick: "Or <b>Click Here</b> to select folder",
            sortMode: "1. Sorting Mode:",
            sortName: "By Name",
            sortTime: "By Playback Order",
            optMode: "2. Optimization:",
            optUPNG: "Enable PNG Compression (UPNG)",
            batchTip: "<b>Tip:</b> If SVGA plays with wrong frames, try \"By Playback Order\".",
            btnExport: "Export New File",
            statusReady: "Ready. Drag & Drop SVGA file to begin.",
            statusError: "‚ùå File format error. Please drop a .svga file."
        },
        zh: {
            title: "SVGA Âä®ÁîªËµÑ‰∫ßÊõøÊç¢Â∑•ÂÖ∑",
            sectionPreview: "Âä®ÁîªÈ¢ÑËßà",
            dragTip: "ÊãñÊãΩ SVGA Êñá‰ª∂Âà∞Ê≠§Â§Ñ (ÊàñÁÇπÂáª‰∏ä‰º†)",
            sectionBg: "ËÉåÊôØÈ¢úËâ≤",
            sectionAssets: "ËµÑÊ∫êÂàóË°®",
            placeholder: "‰∏ä‰º† SVGA Êñá‰ª∂ÂêéÂ∞ÜÂú®Ê≠§Â§ÑÊòæÁ§∫ËµÑÊ∫êÂàóË°®„ÄÇ",
            batchTitle: "üöÄ ÊâπÈáèÂ∏ßÊõøÊç¢",
            batchDrag: "ÊãñÂÖ•ÂõæÁâáËøõË°åÊâπÈáèÊõøÊç¢",
            batchClick: "ÊàñËÄÖ <b>ÁÇπÂáªÊ≠§Â§Ñ</b> ÈÄâÊã©Êñá‰ª∂Â§π",
            sortMode: "1. ÊéíÂ∫èÊ®°Âºè:",
            sortName: "ÊåâÊñá‰ª∂Âêç",
            sortTime: "ÊåâÊí≠ÊîæÈ°∫Â∫è",
            optMode: "2. ÂéãÁº©‰ºòÂåñ:",
            optUPNG: "ÂºÄÂêØ PNG ÂéãÁº© (UPNGÁÆóÊ≥ï)",
            batchTip: "<b>ÊèêÁ§∫:</b> Â¶ÇÊûúÊõøÊç¢ÂêéÂõæÁâáÈ°∫Â∫èÈîô‰π±ÔºåËØ∑Â∞ùËØï‚ÄúÊåâÊí≠ÊîæÈ°∫Â∫è‚Äù„ÄÇ",
            btnExport: "ÂØºÂá∫Êñ∞Êñá‰ª∂",
            statusReady: "Â∞±Áª™„ÄÇËØ∑ÊãñÂÖ• SVGA Êñá‰ª∂ÂºÄÂßã„ÄÇ",
            statusError: "‚ùå Êñá‰ª∂Ê†ºÂºèÈîôËØØ„ÄÇËØ∑ÊãñÂÖ• .svga Êñá‰ª∂„ÄÇ"
        }
    };

    let curLang = 'en';

    function toggleLanguage() {
        curLang = curLang === 'en' ? 'zh' : 'en';
        document.getElementById('langBtn').innerText = curLang === 'en' ? 'ÂàáÊç¢‰∏≠Êñá' : 'Switch to EN';
        
        // Update text for all elements with data-key
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.getAttribute('data-key');
            if(i18n[curLang][key]) {
                el.innerHTML = i18n[curLang][key];
            }
        });
        
        // Update dynamic status if idle
        if(!currentMovieData) {
            setStatus('success', i18n[curLang].statusReady);
        }
    }

    // --- Protobuf Definition (Same as before) ---
    const officialProtoDefinition = `
    syntax = "proto3";
    package com.opensource.svga;
    message MovieParams { float viewBoxWidth = 1; float viewBoxHeight = 2; int32 fps = 3; int32 frames = 4; }
    message Rect { float x = 1; float y = 2; float width = 3; float height = 4; }
    message Transform { float a = 1; float b = 2; float c = 3; float d = 4; float tx = 5; float ty = 6; }
    message Point { float x = 1; float y = 2; }
    message Layout { float x = 1; float y = 2; float width = 3; float height = 4; }
    message ShapeEntity { enum ShapeType { SHAPE = 0; RECT = 1; ROUNDED_RECT = 2; ELLIPSE = 3; POLYGON = 4; TEXT = 5; } ShapeType type = 1; string args = 2; ShapeStyle styles = 3; Transform transform = 4; }
    message ShapeStyle { float fillR = 1; float fillG = 2; float fillB = 3; float fillA = 4; float strokeR = 5; float strokeG = 6; float strokeB = 7; float strokeA = 8; float strokeWidth = 9; float miterLimit = 10; repeated float lineDash = 11; int32 lineCap = 12; int32 lineJoin = 13; }
    message FrameEntity { float alpha = 1; Layout layout = 2; Transform transform = 3; string clipPath = 4; repeated ShapeEntity shapes = 5; repeated string events = 6; repeated string filters = 7; }
    message SpriteEntity { string imageKey = 1; repeated FrameEntity frames = 2; string zPosition = 3; repeated string events = 4; }
    message AudioEntity { string audioKey = 1; int32 startFrame = 2; int32 endFrame = 3; int32 startTime = 4; int32 totalTime = 5; }
    message MovieEntity { string version = 1; MovieParams params = 2; map<string, bytes> images = 3; repeated SpriteEntity sprites = 4; repeated AudioEntity audios = 5; }
    `;

    let MovieEntity = null;
    let currentMovieData = null; 
    let player = null; 
    let parser = null;
    const objectUrls = {};

    function setStatus(type, msg) {
        const el = document.getElementById('statusBar');
        el.style.display = 'block';
        el.className = `status-bar status-${type}`;
        el.innerHTML = msg;
    }

    // --- Init ---
    window.onload = () => {
        try {
            const parsed = protobuf.parse(officialProtoDefinition, { keepCase: true });
            MovieEntity = parsed.root.lookupType("com.opensource.svga.MovieEntity");
            parser = new SVGA.Parser();

            // Color Selector Logic
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.addEventListener('click', (e) => {
                    const color = e.target.getAttribute('data-color');
                    const wrapper = document.getElementById('player-wrapper');
                    const canvas = document.getElementById('playerCanvas');
                    
                    if (color === 'transparent') {
                        // Apply checkerboard class to wrapper
                        wrapper.classList.add('bg-transparent-pattern');
                        canvas.style.backgroundColor = 'transparent';
                    } else {
                        // Remove checkerboard, set solid color
                        wrapper.classList.remove('bg-transparent-pattern');
                        canvas.style.backgroundColor = color; 
                    }
                });
            });
            // Default bg
            document.getElementById('playerCanvas').style.backgroundColor = "#000000";

            // Main Drop Zone
            const dropArea = document.getElementById('player-wrapper');
            const fileInput = document.getElementById('svgaInput');

            dropArea.onclick = (e) => {
                if(e.target.tagName !== 'CANVAS') fileInput.click();
            };

            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                document.getElementById('drag-overlay').classList.add('drag-over');
            });
            dropArea.addEventListener('dragleave', (e) => {
                document.getElementById('drag-overlay').classList.remove('drag-over');
            });
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                document.getElementById('drag-overlay').classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file && file.name.toLowerCase().endsWith('.svga')) {
                    loadFile(file);
                } else {
                    setStatus('error', i18n[curLang].statusError);
                }
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) loadFile(file);
            });

            setupBatchEventListeners();
            setupExportButtonParticles(); // Initialize sparks

            console.log("System initialized.");
        } catch (e) {
            console.error("Init failed:", e);
        }
    };
    
    // --- Load File (Optimized: Removed Resolution Text) ---
    async function loadFile(file) {
        if(!file || !file.name.toLowerCase().endsWith('.svga')) {
            setStatus('error', i18n[curLang].statusError);
            return;
        }
        originalFileName = file.name;
        document.getElementById('downloadBtn').disabled = true;
        document.getElementById('assetsList').innerHTML = `<div class="placeholder">Parsing...</div>`;
        document.getElementById('drag-overlay').classList.add('hidden');
        document.getElementById('playerStatus').style.display = 'block';
        
        let overlay = document.getElementById('fileMetaOverlay');
        overlay.style.display = 'none';
        
        document.getElementById('playerCanvas').innerHTML = ''; 
        if (player) { player.stopAnimation(); player.clear(); }
        player = new SVGA.Player('#playerCanvas'); 
        player.setContentMode("AspectFit"); 
        player.loops = 0; 

        try {
            const buffer = await file.arrayBuffer();
            let inflatedData;
            try { inflatedData = pako.inflate(new Uint8Array(buffer)); } 
            catch (err) { inflatedData = new Uint8Array(buffer); }

            currentMovieData = MovieEntity.decode(inflatedData);
            
            const w = currentMovieData.params.viewBoxWidth;
            const h = currentMovieData.params.viewBoxHeight;
            const fileSizeKB = (file.size / 1024).toFixed(1);
            
            // Calc RAM
            let totalMemBytes = w * h * 4; 
            const imageKeys = Object.keys(currentMovieData.images || {});
            const dimensionPromises = imageKeys.map(key => getImageDimensions(currentMovieData.images[key]));
            const dimensions = await Promise.all(dimensionPromises);
            
            dimensions.forEach(dim => {
                if (dim.width > 0 && dim.height > 0) {
                    totalMemBytes += (dim.width * dim.height * 4);
                }
            });

            const memMB = (totalMemBytes / 1024 / 1024).toFixed(2);
            let memHtml = `<span class="mem-normal">RAM: <b>${memMB} MB</b></span>`;
            if (parseFloat(memMB) > 8.0) {
                memHtml = `<span class="mem-warning">‚ö†Ô∏è High RAM: ${memMB} MB</span>`;
            }

            overlay.innerHTML = `
                <span>File: <b>${file.name}</b></span>
                <span>Size: <b>${fileSizeKB} KB</b></span>
                <span>Dim: <b>${w} x ${h}</b></span>
                ${memHtml}
            `;
            overlay.style.display = 'block';

            setStatus('success', `Parsed: ${imageKeys.length} assets`);
            renderAssetsList(currentMovieData.images);
            tryDynamicPreview(); 

            document.getElementById('downloadBtn').disabled = false;
            // Removed: document.getElementById('fileDimensions').innerText = ... (Requirement 1)

        } catch (err) {
            setStatus('error', "Parse error: " + err.message);
            console.error(err);
            document.getElementById('drag-overlay').classList.remove('hidden');
        }
    }

    // --- Particle Effect for Export Button ---
    function setupExportButtonParticles() {
        const btn = document.getElementById('downloadBtn');
        
        btn.addEventListener('mousemove', function(e) {
            if (btn.disabled) return;
            
            // Throttle creation
            if (Math.random() > 0.3) return;

            const rect = btn.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const particle = document.createElement('div');
            particle.classList.add('particle');
            
            // Random colors
            const colors = ['#00ff80', '#ffffff', '#ffff00', '#00ccff'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            // Random direction
            const destX = (Math.random() - 0.5) * 100 + 'px';
            const destY = (Math.random() - 0.5) * 100 + 'px';
            const size = Math.random() * 4 + 2 + 'px';

            particle.style.backgroundColor = color;
            particle.style.left = x + 'px';
            particle.style.top = y + 'px';
            particle.style.width = size;
            particle.style.height = size;
            particle.style.setProperty('--mx', destX);
            particle.style.setProperty('--my', destY);

            btn.appendChild(particle);

            // Cleanup
            setTimeout(() => {
                particle.remove();
            }, 800);
        });
    }

    // --- Standard Logic (Preview, Pack, Render, Batch) ---
    function tryDynamicPreview() {
        if (!currentMovieData || !player) return; 
        
        player.stopAnimation();
        player.clear(); 
        
        const { viewBoxWidth, viewBoxHeight } = currentMovieData.params;
        const playerCanvas = document.getElementById('playerCanvas');
        playerCanvas.style.width = `${viewBoxWidth}px`;
        playerCanvas.style.height = `${viewBoxHeight}px`;

        try {
            const blob = packSVGA();
            const url = URL.createObjectURL(blob);
            
            parser.load(url, (videoItem) => {
                if (player) {
                    player.setVideoItem(videoItem);
                    player.startAnimation(); 
                    document.getElementById('playerStatus').style.display = 'none';
                }
                URL.revokeObjectURL(url); 
            });
        } catch (e) {
            console.error("Preview error:", e);
        }
    }

    function packSVGA() {
        const message = MovieEntity.create(currentMovieData);
        const encodedBuffer = MovieEntity.encode(message).finish();
        const deflatedData = pako.deflate(encodedBuffer);
        return new Blob([deflatedData], { type: "application/octet-stream" });
    }

    async function getImageDimensions(imgBytes) {
        return new Promise(resolve => {
            if (!imgBytes || imgBytes.length === 0) return resolve({ width: 0, height: 0 });
            const blob = new Blob([imgBytes], { type: 'image/png' }); 
            const url = URL.createObjectURL(blob);
            const img = new Image();
            img.onload = () => { URL.revokeObjectURL(url); resolve({ width: img.width, height: img.height }); };
            img.onerror = () => { URL.revokeObjectURL(url); resolve({ width: 0, height: 0 }); };
            img.src = url;
        });
    }
    
    window.downloadAsset = (event, key) => {
        event.preventDefault(); 
        const imgBytes = currentMovieData.images[key];
        const blob = new Blob([imgBytes], { type: 'application/octet-stream' }); 
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `${key}.png`; 
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url); 
    };

    function renderAssetsList(imagesMap) {
        const container = document.getElementById('assetsList');
        container.innerHTML = '';
        if (!imagesMap || Object.keys(imagesMap).length === 0) {
            container.innerHTML = `<div class="placeholder">${i18n[curLang].placeholder}</div>`;
            return;
        }
        
        const keys = Object.keys(imagesMap).sort(new Intl.Collator(undefined, {numeric: true, sensitivity: 'base'}).compare);

        keys.forEach(key => {
            const imgBytes = imagesMap[key];
            const blob = new Blob([imgBytes], { type: 'image/png' });
            const imgUrl = URL.createObjectURL(blob);
            objectUrls[key] = imgUrl; 
            
            const div = document.createElement('div');
            div.className = 'asset-item';
            div.innerHTML = `
                <div class="asset-preview-wrapper">
                    <img src="${imgUrl}" class="asset-preview">
                    <div class="download-icon" onclick="downloadAsset(event, '${key}')" title="Download">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                    </div>
                </div>
                <div class="asset-info">
                    <div class="asset-key" title="${key}">${key}</div>
                    <div class="asset-meta">${(imgBytes.length / 1024).toFixed(1)} KB</div>
                </div>
                <label class="btn-upload-small">
                    Replace
                    <input type="file" style="display:none" accept="image/*" onchange="handleReplace('${key}', this)">
                </label>
            `;
            container.appendChild(div);

            getImageDimensions(imgBytes).then(dim => {
                const metaDiv = div.querySelector('.asset-meta');
                metaDiv.innerText += ` | ${dim.width}x${dim.height}`;
            });
        });
    }

    window.handleReplace = async (key, inputElement) => {
        const file = inputElement.files[0];
        if (!file) return;
        const buffer = await file.arrayBuffer();
        const newBytes = new Uint8Array(buffer); 
        
        currentMovieData.images[key] = newBytes;
        const blob = new Blob([newBytes], { type: 'image/png' });
        if (objectUrls[key]) URL.revokeObjectURL(objectUrls[key]);
        const newUrl = URL.createObjectURL(blob);
        objectUrls[key] = newUrl; 
        
        const item = inputElement.closest('.asset-item');
        item.querySelector('.asset-preview').src = newUrl;
        
        getImageDimensions(newBytes).then(dim => {
            item.querySelector('.asset-meta').innerText = 
                `${(newBytes.length / 1024).toFixed(1)} KB | ${dim.width}x${dim.height} (New)`;
        });

        setStatus('success', `‚úÖ Replaced "${key}"`);
        tryDynamicPreview(); 
    };

    document.getElementById('downloadBtn').addEventListener('click', () => {
        try {
            const blob = packSVGA();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `svga_remix_${new Date().getTime()}.svga`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); 
            setStatus('success', "‚úÖ File exported successfully!");
        } catch(e) {
            setStatus('error', "‚ùå Export failed: " + e.message);
        }
    });

    function compressImageAsset(file) {
        return new Promise((resolve) => {
            const toggle = document.getElementById('compressToggle');
            const shouldCompress = toggle ? toggle.checked : false;
            
            if (!shouldCompress || typeof UPNG === 'undefined') {
                if(shouldCompress && typeof UPNG === 'undefined') {
                    console.warn("UPNG library missing. Skipping compression.");
                }
                file.arrayBuffer().then(buf => resolve(new Uint8Array(buf)));
                return;
            }

            const img = new Image();
            const url = URL.createObjectURL(file);
            
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                try {
                    const imgData = ctx.getImageData(0, 0, img.width, img.height);
                    const compressedBuffer = UPNG.encode([imgData.data.buffer], img.width, img.height, 256);
                    resolve(new Uint8Array(compressedBuffer));
                } catch (e) {
                    console.error("Compression failed:", e);
                    file.arrayBuffer().then(buf => resolve(new Uint8Array(buf)));
                }
                URL.revokeObjectURL(url);
            };
            img.onerror = () => {
                file.arrayBuffer().then(buf => resolve(new Uint8Array(buf)));
            };
            img.src = url;
        });
    }

    function getKeysSortedByTimeline(movieData) {
        const appearanceMap = {}; 
        const imageKeys = Object.keys(movieData.images || {});
        imageKeys.forEach(key => appearanceMap[key] = Infinity);

        (movieData.sprites || []).forEach(sprite => {
            const key = sprite.imageKey;
            if (!key || !movieData.images[key]) return;
            (sprite.frames || []).forEach((frame, frameIndex) => {
                if (frame.alpha > 0) {
                    if (frameIndex < appearanceMap[key]) {
                        appearanceMap[key] = frameIndex;
                    }
                }
            });
        });

        return imageKeys.sort((a, b) => {
            const frameA = appearanceMap[a];
            const frameB = appearanceMap[b];
            if (frameA === frameB) return a.localeCompare(b);
            return frameA - frameB;
        });
    }

    async function processFileList(fileList) {
        if (!currentMovieData) {
            setStatus('error', i18n[curLang].statusError);
            return;
        }

        const logEl = document.getElementById('batchLog');
        logEl.style.display = 'block';
        logEl.innerText = "> Analyzing input...\n";
        
        const validImages = fileList.filter(f => f.name.match(/\.(png|jpg|jpeg)$/i));
        if (validImages.length === 0) {
            logEl.innerText += "Error: No valid images found.\n";
            return;
        }

        const naturalSort = new Intl.Collator(undefined, {numeric: true, sensitivity: 'base'}).compare;
        validImages.sort((a, b) => naturalSort(a.name, b.name));

        const sortMode = document.querySelector('input[name="sortMode"]:checked').value;
        let svgaKeys;

        if (sortMode === 'timeline') {
            logEl.innerText += "> Mode: Sort by Timeline...\n";
            svgaKeys = getKeysSortedByTimeline(currentMovieData);
        } else {
            logEl.innerText += "> Mode: Sort by Filename...\n";
            svgaKeys = Object.keys(currentMovieData.images).sort(naturalSort);
        }

        logEl.innerText += `> Processing ${validImages.length} images... (May take a moment)\n`;
        logEl.innerText += `----------------------------------------\n`;

        const count = Math.min(svgaKeys.length, validImages.length);
        
        for (let i = 0; i < count; i++) {
            const key = svgaKeys[i];
            const file = validImages[i];

            await new Promise(r => setTimeout(r, 10));

            logEl.innerText += `> [${i+1}/${count}] Compressing: ${file.name}...\n`;
            logEl.scrollTop = logEl.scrollHeight;

            const compressedBytes = await compressImageAsset(file);
            currentMovieData.images[key] = compressedBytes;
            
            const ratio = Math.round((1 - compressedBytes.length / file.size) * 100);
            const sizeInfo = ratio > 0 ? `[‚¨áÔ∏è${ratio}%]` : `[Raw]`;
            
            const lines = logEl.innerText.split('\n');
            lines.pop(); lines.pop(); 
            logEl.innerText = lines.join('\n') + `\n[${i+1}] ${key.substring(0,8)}... <== ${file.name} ${sizeInfo}\n`;
        }
        
        logEl.innerText += `----------------------------------------\nDone!\n`;
        logEl.scrollTop = logEl.scrollHeight;
        
        setStatus('success', `Batch replaced ${count} images!`);
        renderAssetsList(currentMovieData.images); 
        tryDynamicPreview(); 
    }
    
    // Setup Batch Listeners
    function setupBatchEventListeners() {
        const zone = document.getElementById('batchDropZone');
        const folderInput = document.getElementById('batchFolderInput');
        
        const inputs = zone.querySelectorAll('input, label');
        inputs.forEach(el => { el.addEventListener('click', (e) => { e.stopPropagation(); }); });

        zone.onclick = (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL') return;
            folderInput.value = ''; folderInput.click();
        };

        folderInput.onchange = (e) => {
            const files = Array.from(e.target.files);
            if(files.length > 0) processFileList(files);
        };

        zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('drag-over'); };
        zone.ondragleave = () => { zone.classList.remove('drag-over'); };
        zone.ondrop = (e) => {
            e.preventDefault(); zone.classList.remove('drag-over');
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) processFileList(files);
            else {
                const logEl = document.getElementById('batchLog');
                logEl.style.display = 'block';
                logEl.innerText = "‚ö†Ô∏è Browser restricted folder access. Click box to select folder.";
            }
        };
    }	
</script>
</body>
</html>